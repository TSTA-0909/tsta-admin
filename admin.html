<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ç®¡ç†è€…ï¼šäºˆç´„æ—¥è¨­å®š</title>
  <style>
/* -- ã“ã“ã¯ä»Šã¾ã§ã®ã¾ã¾ -- */
body {
  font-family: sans-serif;
  padding: 20px;
  background: #f0f0f0;
  margin: 0;
}
.calendar-container { display: flex; flex-direction: column; gap: 20px; align-items: center; }
table { border-collapse: collapse; margin-bottom: 10px; }
th, td { width: 36px; height: 36px; border: 1px solid #ccc; text-align: center; cursor: pointer; font-size: 14px; }
td.today { background: #ffe4b2; }
td.selected { background: #add8e6; transform: scale(1.2); font-weight: bold; }
td.available { background: #c0ffc0; }
td.disabled { background: #eee; color: #aaa; cursor: default; }
.section { margin-top: 20px; background: white; padding: 10px; border-radius: 6px; max-width: 100%; width: 100%; box-sizing: border-box; }
.name-list div, .comment-box { padding: 6px 0; }
.name-list button, .comment-box button { margin-top: 4px; font-size: 14px; }
.comment-box textarea { width: 100%; font-size: 14px; padding: 6px; box-sizing: border-box; }
.user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #ccc; }
.user-item:hover { background: #eee; }
.chat-message { margin: 6px 0; font-size: 14px; }
.chat-message.admin { text-align: right; }
.chat-message .sender { font-weight: bold; }
.chat-message .text { display: inline-block; margin-left: 6px; }
.badge { background: red; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 4px; }
@media screen and (max-width: 600px) {
  th, td { width: 30px; height: 30px; font-size: 12px; }
  .calendar-container { flex-direction: column; }
  .section { padding: 10px; font-size: 14px; }
  textarea, input, button { font-size: 16px; width: 100%; box-sizing: border-box; }
  button { margin-top: 8px; }
  .name-list div { font-size: 15px; }
}
  </style>
</head>
<body>
<body>
  <h1>ç®¡ç†è€…ï¼šäºˆç´„æ—¥è¨­å®š</h1>
  <div id="uidDisplay" style="font-size:14px; color:#007acc; margin-bottom:8px;"></div>
  <!-- ...ï¼ˆã“ã“ã‹ã‚‰ä¸‹ã¯æ—¢å­˜ã®ç”»é¢è¦ç´ ï¼‰... -->
  <div class="calendar-container" id="calendarArea"></div>
  <div class="section">
    <h3>é¸æŠæ—¥ï¼š<span id="selectedDateDisplay">æœªé¸æŠ</span></h3>
    <label>åˆå¿ƒè€…ä¸Šé™ï¼š<input type="number" id="beginner" value="2"></label><br>
    <label>çµŒé¨“è€…ä¸Šé™ï¼š<input type="number" id="experienced" value="2"></label><br>
    <button id="saveBtn">äºˆç´„å¯èƒ½ã«ã™ã‚‹</button>
    <p id="status"></p>
  </div>
  <div class="section">
    <h3>ğŸ“¢ ãŠçŸ¥ã‚‰ã›ç®¡ç†</h3>
    <textarea id="noticeInput" rows="3" style="width: 100%;"></textarea><br>
    <button id="saveNoticeBtn">ãŠçŸ¥ã‚‰ã›ã‚’ä¿å­˜</button>
    <p id="noticeStatus"></p>
  </div>
  <div class="section" id="reservationInfo" style="display:none;">
    <h3>ğŸ” å‚åŠ è€…ä¸€è¦§ï¼ˆé¸æŠæ—¥ï¼‰</h3>
    <div id="beginnerList" class="name-list"></div>
    <div id="experiencedList" class="name-list"></div>
  </div>
  <div class="section" id="commentSection">
    <h3>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆã‚„ã‚Šå–ã‚Š</h3>
    <div id="userList"></div>
    <hr>
    <div id="chatBox"></div>
    <textarea id="replyText" rows="2" placeholder="è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›"></textarea>
    <button id="sendReply">è¿”ä¿¡ã™ã‚‹</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDocs, getDoc, addDoc, collection,
      deleteDoc, query, where, onSnapshot, serverTimestamp, orderBy
    } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC3pcdWqFwrvokCUyGGJlg_ruQ-6wUSZT8",
      authDomain: "tsta-reserve.firebaseapp.com",
      projectId: "tsta-reserve",
      storageBucket: "tsta-reserve.appspot.com",
      messagingSenderId: "242251329752",
      appId: "1:242251329752:web:f70718703ba8e35298a7ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    let selectedDate = null;
    let configMap = {};
    let selectedUID = null;
    let selectedName = "";

    const formatDate = (date) => {
      const jst = new Date(date.getTime() + (9 * 60 * 60 * 1000));
      return jst.toISOString().split("T")[0];
    };

    async function loadConfigFromFirestore() {
      const snap = await getDocs(collection(db, "config"));
      configMap = {};
      snap.forEach(doc => configMap[doc.id] = doc.data());
    }

    function renderCalendar() {
      const area = document.getElementById("calendarArea");
      area.innerHTML = "";
      const today = new Date();
      for (let m = 0; m < 2; m++) {
        const date = new Date(today.getFullYear(), today.getMonth() + m, 1);
        const table = document.createElement("table");
        const caption = document.createElement("caption");
        caption.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
        table.appendChild(caption);

        const head = document.createElement("tr");
        ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"].forEach(d => {
          const th = document.createElement("th");
          th.textContent = d;
          head.appendChild(th);
        });
        table.appendChild(head);

        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        let row = document.createElement("tr");
        for (let i = 0; i < firstDay.getDay(); i++) row.appendChild(document.createElement("td"));

        for (let d = 1; d <= lastDay.getDate(); d++) {
          const day = new Date(date.getFullYear(), date.getMonth(), d);
          const dateStr = formatDate(day);
          const td = document.createElement("td");
          td.textContent = d;
          if (dateStr === formatDate(new Date())) td.classList.add("today");
          if (configMap[dateStr]) td.classList.add("available");

          td.onclick = () => {
            selectedDate = dateStr;
            document.querySelectorAll("td").forEach(cell => cell.classList.remove("selected"));
            td.classList.add("selected");
            document.getElementById("selectedDateDisplay").textContent = selectedDate;
            loadReservations(dateStr);
          };

          row.appendChild(td);
          if (day.getDay() === 6) {
            table.appendChild(row);
            row = document.createElement("tr");
          }
        }

        table.appendChild(row);
        area.appendChild(table);
      }
    }

    async function loadReservations(dateStr) {
      const q = query(collection(db, "reservations"), where("date", "==", dateStr));
      const snapshot = await getDocs(q);
      const beginner = [], experienced = [];
      const allReservations = await getDocs(collection(db, "reservations"));

      const counts = {};
      allReservations.forEach(doc => {
        const data = doc.data();
        if (data.name) {
          counts[data.name] = (counts[data.name] || 0) + 1;
        }
      });

      snapshot.forEach(doc => {
        const data = doc.data();
        const entry = { ...data, id: doc.id, count: counts[data.name] || 1 };
        if (data.type === "beginner") beginner.push(entry);
        else if (data.type === "experienced") experienced.push(entry);
      });

      document.getElementById("reservationInfo").style.display = "block";

      document.getElementById("beginnerList").innerHTML =
        `<h4>åˆå¿ƒè€…ï¼ˆ${beginner.length}äººï¼‰</h4>` +
        beginner.map(p => `<div>${p.name}ï¼ˆ${p.count}å›ï¼‰ <button onclick="cancel('${p.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>`).join("");

      document.getElementById("experiencedList").innerHTML =
        `<h4>çµŒé¨“è€…ï¼ˆ${experienced.length}äººï¼‰</h4>` +
        experienced.map(p => `<div>${p.name}ï¼ˆ${p.count}å›ï¼‰ <button onclick="cancel('${p.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>`).join("");
    }

    window.cancel = async function(id) {
      if (!confirm("æœ¬å½“ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await deleteDoc(doc(db, "reservations", id));
      if (selectedDate) loadReservations(selectedDate);
    };

    async function saveConfig() {
      if (!selectedDate) return alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„");
      const beginner = parseInt(document.getElementById("beginner").value);
      const experienced = parseInt(document.getElementById("experienced").value);
      const config = { enabled: true, beginner_limit: beginner, experienced_limit: experienced };
      try {
        await setDoc(doc(db, "config", selectedDate), config);
        configMap[selectedDate] = config;
        renderCalendar();
        document.getElementById("status").textContent = "è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ";
      } catch (e) {
        console.error("ä¿å­˜å¤±æ•—:", e);
        document.getElementById("status").textContent = "ä¿å­˜å¤±æ•—: " + (e.message || e);
      }
    }

    async function saveNotice() {
      const text = document.getElementById("noticeInput").value;
      try {
        await setDoc(doc(db, "config", "notice"), { text });
        document.getElementById("noticeStatus").textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
      } catch (e) {
        console.error("ãŠçŸ¥ã‚‰ã›ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
        document.getElementById("noticeStatus").textContent = "ä¿å­˜å¤±æ•—: " + (e.message || e);
      }
    }

    function setupCommentListener() {
      const q = query(collection(db, "comments"));
      onSnapshot(q, (snapshot) => {
        const latestByUser = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          const { uid, name, text, timestamp, readByAdmin, repliedByAdmin, sender } = data;
          if (!latestByUser[uid] || data.timestamp?.seconds > latestByUser[uid].timestamp?.seconds) {
            latestByUser[uid] = { name, text, timestamp, uid, readByAdmin, repliedByAdmin, sender };
          }
        });

        const userList = document.getElementById("userList");
        userList.innerHTML = Object.values(latestByUser).sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds)
          .map(u => {
            let badge = "";
            if (!u.readByAdmin) badge += '<span class="badge">æœªèª­</span>';
            else if (!u.repliedByAdmin && u.sender === "user") badge += '<span class="badge">æœªè¿”ä¿¡</span>';
            return `<div class="user-item" data-uid="${u.uid}" data-name="${u.name}">ğŸ‘¤ ${u.name}ï¼šã€Œ${u.text}ã€${badge}</div>`;
          }).join("");
      });

      document.getElementById("userList").addEventListener("click", (e) => {
        const div = e.target.closest(".user-item");
        if (!div) return;
        selectedUID = div.dataset.uid;
        selectedName = div.dataset.name;
        loadChatHistory(selectedUID);
      });
    }

    function loadChatHistory(uid) {
      const q = query(collection(db, "comments"), where("uid", "==", uid), orderBy("timestamp"));
      onSnapshot(q, (snapshot) => {
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "chat-message " + (data.sender === "admin" ? "admin" : "user");
          div.innerHTML = `<span class="sender">${data.sender === "admin" ? "ğŸ›  ç®¡ç†è€…" : `ğŸ‘¤ ${data.name}`}</span><span class="text">${data.text}</span>`;
          chatBox.appendChild(div);
        });
      });
    }

    document.getElementById("sendReply").addEventListener("click", async () => {
      const text = document.getElementById("replyText").value.trim();
      if (!text || !selectedUID) return alert("è¿”ä¿¡å†…å®¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„");
      await addDoc(collection(db, "comments"), {
        uid: selectedUID,
        name: selectedName,
        text,
        sender: "admin",
        timestamp: serverTimestamp(),
        readByAdmin: true,
        repliedByAdmin: true
      });
      document.getElementById("replyText").value = "";
    });

    // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰èªè¨¼å‡¦ç†ã‚’åŠ ãˆãŸæœ¬ç•ªç‰ˆ â–¼â–¼â–¼
    signInAnonymously(auth).then(() => {
      // èªè¨¼å¾Œã®UIDã‚’è¡¨ç¤ºã—ã¦adminsç™»éŒ²ã‚‚ç¢ºèªã—ã‚„ã™ã
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          document.getElementById("uidDisplay").textContent = "ç®¡ç†è€…UID: " + user.uid;
          await loadConfigFromFirestore();
          renderCalendar();
          document.getElementById("saveBtn").addEventListener("click", saveConfig);
          document.getElementById("saveNoticeBtn").addEventListener("click", saveNotice);
          setupCommentListener();

          try {
            const docSnap = await getDoc(doc(db, "config", "notice"));
            if (docSnap.exists()) {
              document.getElementById("noticeInput").value = docSnap.data().text || "";
            }
          } catch (e) {
            console.error("ãŠçŸ¥ã‚‰ã›èª­ã¿è¾¼ã¿å¤±æ•—:", e);
          }
        }
      });
    });
    // â–²â–²â–² ã“ã“ã¾ã§è¿½åŠ  â–²â–²â–²

  </script>
</body>
</html>
